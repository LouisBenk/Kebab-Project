<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>D√∂nerd ‚Äì Shop hinzuf√ºgen</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    :root{
      --bg:#f0f0f0; --text:#111; --muted:#6b7280; --card:#ffffff;
      --ring:#e5e7eb; --chip:#eef0f3; --chipText:#0f172a;
      --accent:#fb923c; --accent-strong:#f97316;
      --blue:#38bdf8; --green:#34d399; --rose:#fb7185; --vio:#a78bfa;
      --shadow:0 8px 24px rgba(0,0,0,.14);
      --nav-pill-w:140px;
    }

    html, body { margin:0; height:100%; background:var(--bg); color:var(--text); font-family:Arial, sans-serif; }
    button{font:inherit}

    /* Top bar (kept like index) */
    .navbar{position:sticky;top:0;z-index:10;background:transparent;display:flex;justify-content:center;padding:12px 16px}
    .nav-inner{width:100%;max-width:1280px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:8px;font-weight:900;font-size:22px}
    .brand .dot{width:12px;height:12px;border-radius:50%;background:#ff385c;display:inline-block}
    .right-actions{display:flex;align-items:center;gap:12px;margin-left:auto}
    .action-pill{flex:0 0 var(--nav-pill-w);min-width:var(--nav-pill-w);display:flex;align-items:center;justify-content:center;gap:8px;padding:8px 14px;background:#fff;border-radius:999px;border:1px solid var(--ring);cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.06);font-weight:700;white-space:nowrap}
    .action-pill:hover{background:#f9fafb}
    .action-icon{width:18px;height:18px;display:inline-grid;place-items:center;border-radius:50%;background:#f3f4f6;font-size:12px;color:#374151}
    .lang-toggle{display:inline-flex;align-items:center;background:#fff;border:1px solid var(--ring);border-radius:999px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .lang-toggle button{min-width:60px;padding:8px 12px;font-weight:800;background:transparent;border:0;cursor:pointer;white-space:nowrap}
    .lang-toggle button+button{border-left:1px solid var(--ring)}
    .lang-toggle button.is-active{background:var(--accent);color:#000}

    /* Card */
    .wrap{display:flex;justify-content:center;padding:20px}
    .card{width:min(980px,96vw);background:var(--card);border-radius:20px;box-shadow:var(--shadow);padding:22px 22px 26px}
    .title{font-size:28px;font-weight:900;margin:0 0 6px}
    .subtitle{color:var(--muted);margin:0 0 14px}
    hr.sep{border:none;border-top:1px solid var(--ring);margin:14px 0 18px}

    /* Sections */
    .section{margin-top:18px}
    .section h4{margin:0 0 10px;font-size:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:820px){ .grid{grid-template-columns:1fr} }

    /* Inputs */
    .field{display:flex;flex-direction:column;gap:6px}
    .label-row{display:flex;align-items:center;gap:8px;font-weight:800}
    .label-icon{width:22px;height:22px;display:grid;place-items:center;border-radius:8px;background:#f3f4f6}
    .field input[type="text"], .field input[type="number"]{border:1px solid var(--ring);border-radius:12px;padding:12px 14px;font-size:14px;outline:0}
    .field input[type="text"]:focus, .field input[type="number"]:focus{box-shadow:0 0 0 3px rgba(249,115,22,.25)}

    /* Chips */
    .chip-row{display:flex;flex-wrap:wrap;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;background:var(--chip);color:var(--chipText);border:1px solid var(--ring);cursor:pointer;user-select:none;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .chip input{display:none}
    .chip.active{background:rgba(249,115,22,.14);border-color:rgba(249,115,22,.35)}
    .chip .em{opacity:.9}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#f8fafc;border:1px solid var(--ring);border-radius:999px;padding:8px 12px}
    .pill strong{font-size:12px}
    .coords{display:flex;gap:10px;flex-wrap:wrap}

    /* Map */
    #map{height:320px;border-radius:14px;border:1px solid var(--ring);box-shadow:0 4px 12px rgba(0,0,0,.08)}

    /* Buttons ‚Äì refreshed to match index look */
    .actions{display:flex;gap:12px;justify-content:center;margin-top:22px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;font-weight:900;border:none;cursor:pointer;transition:transform .05s ease, box-shadow .15s ease}
    .btn:active{transform:translateY(1px)}

    .btn-primary{
      width:100%;max-width:440px;border-radius:999px;padding:14px 18px;
      background:linear-gradient(180deg,#fdbb74 0%,#fb923c 50%,#f97316 100%);
      color:#000;box-shadow:0 10px 22px rgba(249,115,22,.35)
    }
    .btn-primary:hover{filter:saturate(1.05) brightness(1.02)}

    .btn-secondary{
      border-radius:999px;padding:12px 16px;
      background:#fff;border:1px solid var(--ring);color:#0f172a;box-shadow:0 6px 14px rgba(0,0,0,.08)
    }
    .btn-secondary:hover{background:#f9fafb}

    .btn-blue{background:linear-gradient(180deg,#9bdcff,#38bdf8);color:#04243a;border:0}
    .btn-green{background:linear-gradient(180deg,#90f0c9,#34d399);color:#053524;border:0}
    .btn-rose{background:linear-gradient(180deg,#ffc1cf,#fb7185);color:#3a1016;border:0}
    .btn-vio{background:linear-gradient(180deg,#d6c7ff,#a78bfa);color:#1e1640;border:0}

    .i{width:18px;height:18px;display:grid;place-items:center;border-radius:999px;background:#fff1;border:1px solid #0001}
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <div class="nav-inner">
      <div class="brand" aria-label="D√∂nerd"><span class="dot"></span><span>D√∂nerd</span></div>
      <div class="right-actions">
        <button class="action-pill" onclick="location.href='index.html'"><span class="action-icon">üó∫Ô∏è</span><span data-i18n="nav.map">Karte</span></button>
        <button class="action-pill" onclick="location.href='feedback.html'"><span class="action-icon">üí¨</span><span data-i18n="nav.feedback">Feedback</span></button>
        <button class="action-pill" onclick="location.href='selection.html'"><span class="action-icon">üìã</span><span data-i18n="nav.selection">Preisliste</span></button>
        <button class="action-pill" onclick="location.href='about.html'"><span class="action-icon">üë§</span><span data-i18n="nav.about">√úber mich</span></button>
        <div class="lang-toggle" role="group" aria-label="Language">
          <button type="button" data-lang="de" aria-pressed="false">DE</button>
          <button type="button" data-lang="en" aria-pressed="false">EN</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTENT -->
  <main class="wrap">
    <section class="card" aria-label="Shop hinzuf√ºgen">
      <h1 class="title">üßæ <span data-i18n="add.title">Shop hinzuf√ºgen</span></h1>
      <p class="subtitle" data-i18n="add.subtitle">Trage die Grunddaten ein und setze den Pin auf der Karte.</p>
      <hr class="sep" />

      <!-- Basics -->
      <div class="section">
        <h4 class="label-row"></span><span data-i18n="add.basics">Basis</span></h4>
        <div class="grid">
          <div class="field">
            <div class="label-row"></span><label for="name" data-i18n="add.name">Name</label></div>
            <input id="name" type="text" placeholder="Hasir, R√ºyam‚Ä¶" data-i18n-placeholder="add.namePh" />
          </div>
          <div class="field">
            <div class="label-row"><span class="label-icon">üìç</span><label for="address" data-i18n="add.addr">Adresse</label></div>
            <input id="address" type="text" placeholder="Stra√üe 1, Berlin‚Ä¶" data-i18n-placeholder="add.addrPh" />
          </div>
        </div>
      </div>

      <!-- Location -->
      <div class="section">
        <h4 class="label-row"></span><span data-i18n="add.location">Standort</span></h4>
        <div id="map"></div>
        <div class="coords" style="margin-top:10px;">
          <button id="geoBtn" class="btn btn-secondary btn-blue" type="button"></span><span data-i18n="add.locate">üìç Meine Position</span></button>
          <div class="pill"><strong>Lat</strong><span id="latOut">‚Äì</span></div>
          <div class="pill"><strong>Lng</strong><span id="lngOut">‚Äì</span></div>
        </div>
      </div>

      <!-- Categories -->
      <div class="section">
        <h4 class="label-row"></span><span data-i18n="cat.title">Kategorie</span></h4>
        <div class="chip-row">
          <label class="chip"><input type="checkbox" id="vegOnly"><span class="em">ü•¨</span><span data-i18n="cat.veg">Vegetarisch</span></label>
          <label class="chip"><input type="checkbox" id="meatOnly"><span class="em">üçñ</span><span data-i18n="cat.meat">Fleisch</span></label>
          <label class="chip"><input type="checkbox" id="saucesOnly"><span class="em">ü•´</span><span data-i18n="cat.sauces">Saucen</span></label>
          <label class="chip"><input type="checkbox" id="breadOnly"><span class="em">ü•ñ</span><span data-i18n="cat.bread">Brot hausgemacht</span></label>
        </div>
      </div>

      <div class="section" id="vegSub" style="display:none">
        <h4 class="label-row"><span class="label-icon">ü•¨</span><span data-i18n="veg.title">Vegetarisch ‚Äì Typen</span></h4>
        <div class="chip-row">
          <label class="chip"><input type="checkbox" class="vegType" value="falafel"><span>Falafel</span></label>
          <label class="chip"><input type="checkbox" class="vegType" value="halloumi"><span>Halloumi</span></label>
          <label class="chip"><input type="checkbox" class="vegType" value="seitan"><span>Seitan</span></label>
        </div>
      </div>

      <div class="section" id="meatSub" style="display:none">
        <h4 class="label-row"><span class="label-icon">üçñ</span><span data-i18n="meat.title">Fleisch ‚Äì Typen</span></h4>
        <div class="chip-row">
          <label class="chip"><input type="checkbox" class="meatType" value="chicken"><span>H√§hnchen</span></label>
          <label class="chip"><input type="checkbox" class="meatType" value="veal"><span>Kalb</span></label>
          <label class="chip"><input type="checkbox" class="meatType" value="lamb"><span>Lamm</span></label>
          <label class="chip"><input type="checkbox" class="meatType" value="other"><span>Andere</span></label>
        </div>
      </div>

      <div class="section" id="sauceSub" style="display:none">
        <h4 class="label-row"><span class="label-icon">ü•´</span><span data-i18n="sauce.title">Saucen ‚Äì Typen</span></h4>
        <div class="chip-row">
          <label class="chip"><input type="checkbox" class="sauceType" value="spicy"><span>Scharf</span></label>
          <label class="chip"><input type="checkbox" class="sauceType" value="garlic"><span>Knoblauch</span></label>
          <label class="chip"><input type="checkbox" class="sauceType" value="cocktail"><span>Cocktail</span></label>
          <label class="chip"><input type="checkbox" class="sauceType" value="homemade"><span>Hausgemacht</span></label>
        </div>
      </div>

      <!-- Prices -->
      <div class="section">
        <h4 class="label-row"></span><span data-i18n="price.title">Preise</span></h4>
        <div class="grid">
          <div class="field">
            <div class="label-row"><span class="label-icon">ü•ô</span><label for="pK" data-i18n="price.kebap">Kebap ‚Ç¨</label></div>
            <input id="pK" type="number" step="0.1" min="0" placeholder="z.B. 5.5">
          </div>
          <div class="field">
            <div class="label-row"><span class="label-icon">üåØ</span><label for="pD" data-i18n="price.durum">D√ºr√ºm ‚Ç¨</label></div>
            <input id="pD" type="number" step="0.1" min="0" placeholder="z.B. 6.0">
          </div>
          <div class="field">
            <div class="label-row"><span class="label-icon">üì¶</span><label for="pB" data-i18n="price.box">Box ‚Ç¨</label></div>
            <input id="pB" type="number" step="0.1" min="0" placeholder="z.B. 7.0">
          </div>
        </div>
      </div>

      <!-- Opening days -->
      <div class="section">
        <h4 class="label-row"><span class="label-icon">üìÖ</span><span data-i18n="weekday.title">Wochentag</span></h4>
        <div class="chip-row">
          <label class="chip"><input type="checkbox" class="dayFilter" value="mon"><span>Montag</span></label>
          <label class="chip"><input type="checkbox" class="dayFilter" value="tue"><span>Dienstag</span></label>
          <label class="chip"><input type="checkbox" class="dayFilter" value="wed"><span>Mittwoch</span></label>
          <label class="chip"><input type="checkbox" class="dayFilter" value="thu"><span>Donnerstag</span></label>
          <label class="chip"><input type="checkbox" class="dayFilter" value="fri"><span>Freitag</span></label>
          <label class="chip"><input type="checkbox" class="dayFilter" value="sat"><span>Samstag</span></label>
          <label class="chip"><input type="checkbox" class="dayFilter" value="sun"><span>Sonntag</span></label>
        </div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button id="saveBtn" class="btn btn-primary" type="button"><span class="i">‚úÖ</span><span data-i18n="add.create">Anlegen</span></button>
        <button class="btn btn-secondary" type="button" onclick="location.href='index.html'"><span class="i">‚Ü©Ô∏è</span><span data-i18n="add.cancel">Abbrechen</span></button>
      </div>
    </section>
  </main>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- i18n (unchanged strings, just reused) -->
  <script>
    const DICTS={de:{
      nav:{map:"Karte", feedback:"Feedback", selection:"Preisliste", about:"√úber mich"},
      add:{title:"Shop hinzuf√ºgen", subtitle:"Trage die Grunddaten ein und setze den Pin auf der Karte.", basics:"Basis",
           name:"Name", namePh:"Hasir, R√ºyam‚Ä¶", addr:"Adresse", addrPh:"Stra√üe 1, Berlin‚Ä¶",
           location:"Standort", locate:"üìç Meine Position", create:"Anlegen", cancel:"Abbrechen"},
      cat:{title:"Kategorie", veg:"Vegetarisch", meat:"Fleisch", sauces:"Saucen", bread:"Brot hausgemacht"},
      veg:{title:"Vegetarisch ‚Äì Typen", falafel:"Falafel", halloumi:"Halloumi", seitan:"Seitan"},
      meat:{title:"Fleisch ‚Äì Typen", chicken:"H√§hnchen", veal:"Kalb", lamb:"Lamm", other:"Andere"},
      sauce:{title:"Saucen ‚Äì Typen", spicy:"Scharf", garlic:"Knoblauch", cocktail:"Cocktail", homemade:"Hausgemacht"},
      price:{title:"Preise", kebap:"Kebap ‚Ç¨", durum:"D√ºr√ºm ‚Ç¨", box:"Box ‚Ç¨"},
      weekday:{title:"Wochentag", mon:"Montag", tue:"Dienstag", wed:"Mittwoch", thu:"Donnerstag", fri:"Freitag", sat:"Samstag", sun:"Sonntag"},
      msg:{needName:"Bitte einen Namen eingeben.", needPos:"Bitte einen Punkt auf der Karte setzen.",
           saved:"Shop gespeichert ‚úÖ", saving:"Speichere‚Ä¶", error:"Speichern fehlgeschlagen. Details in der Konsole."}
    }, en:{
      nav:{map:"Map", feedback:"Feedback", selection:"Price list", about:"About me"},
      add:{title:"Add Shop", subtitle:"Fill the basics and drop the pin on the map.", basics:"Basics",
           name:"Name", namePh:"Hasir, R√ºyam‚Ä¶", addr:"Address", addrPh:"Street 1, Berlin‚Ä¶",
           location:"Location", locate:"üìç My location", create:"Create", cancel:"Cancel"},
      cat:{title:"Category", veg:"Vegetarian", meat:"Meat", sauces:"Sauces", bread:"Homemade bread"},
      veg:{title:"Vegetarian ‚Äì Types", falafel:"Falafel", halloumi:"Halloumi", seitan:"Seitan"},
      meat:{title:"Meat ‚Äì Types", chicken:"Chicken", veal:"Veal", lamb:"Lamb", other:"Other"},
      sauce:{title:"Sauces ‚Äì Types", spicy:"Spicy", garlic:"Garlic", cocktail:"Cocktail", homemade:"Homemade"},
      price:{title:"Prices", kebap:"Kebap ‚Ç¨", durum:"Durum ‚Ç¨", box:"Box ‚Ç¨"},
      weekday:{title:"Weekday", mon:"Monday", tue:"Tuesday", wed:"Wednesday", thu:"Thursday", fri:"Friday", sat:"Saturday", sun:"Sunday"},
      msg:{needName:"Please enter a name.", needPos:"Please set a point on the map.",
           saved:"Shop saved ‚úÖ", saving:"Saving‚Ä¶", error:"Save failed. See console."}
    }};
    const I18N=(()=>{let lang='de',dict=DICTS.de;
      const get=(o,p)=>p.split('.').reduce((a,k)=>a&&a[k]!=null?a[k]:undefined,o);
      const t=(k,fb)=>get(dict,k)??fb??k;
      function apply(){
        document.querySelectorAll('[data-i18n]').forEach(el=>el.textContent=t(el.dataset.i18n,el.textContent.trim()));
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>el.placeholder=t(el.dataset.i18nPlaceholder,el.placeholder));
        document.documentElement.lang=lang;
        document.querySelectorAll('.lang-toggle [data-lang]').forEach(b=>{const on=b.dataset.lang===lang; b.classList.toggle('is-active',on); b.setAttribute('aria-pressed',on?'true':'false');});
      }
      function set(l){lang=l;dict=DICTS[l]||DICTS.de;localStorage.setItem('lang',l);apply();}
      function init(){set(localStorage.getItem('lang')||(['de','en'].includes((navigator.language||'').slice(0,2))?(navigator.language||'').slice(0,2):'de'));
        document.addEventListener('click',e=>{const b=e.target.closest('.lang-toggle [data-lang]'); if(b) set(b.dataset.lang);});}
      return {init,t};
    })();
    document.addEventListener('DOMContentLoaded', I18N.init);
  </script>

  <!-- Page logic -->
  <script>
    const SUPABASE_URL  = 'https://bcxeaxhhhvagpvomtsyi.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjeGVheGhoaHZhZ3B2b210c3lpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNTUxMzcsImV4cCI6MjA3MDgzMTEzN30.HCnWgapZrDY4RIgdXM5eh2UkslFpSSuJwEUszZHtp0w';
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    let map, marker=null;
    const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));

    function refreshChips(){ $$('.chip').forEach(lb=>{ const input=lb.querySelector('input'); if(!input) return; lb.classList.toggle('active', input.checked);}); }
    function toggleSubs(){ $('#vegSub').style.display=$('#vegOnly').checked?'':'none'; $('#meatSub').style.display=$('#meatOnly').checked?'':'none'; $('#sauceSub').style.display=$('#saucesOnly').checked?'':'none'; }

    document.addEventListener('change', e=>{
      if(e.target.matches('.chip input')) refreshChips();
      if(['vegOnly','meatOnly','saucesOnly'].includes(e.target.id)) toggleSubs();
    });

    const toNum = (v)=>{ if(v===''||v==null) return null; const n=parseFloat(String(v).replace(',','.')); return Number.isFinite(n)?n:null; };

    function slugify(s){
      return String(s).toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')
        || 'shop';
    }
    function randomId(len=5){
      const chars='abcdefghjkmnpqrstuvwxyz23456789';
      let out=''; for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)];
      return out;
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // Map
      map = L.map('map').setView([52.502,13.402],13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      function setMarker(lat,lng){
        if(marker) map.removeLayer(marker);
        marker=L.marker([lat,lng]).addTo(map);
        $('#latOut').textContent=Number(lat).toFixed(6);
        $('#lngOut').textContent=Number(lng).toFixed(6);
      }
      map.on('click', e=> setMarker(e.latlng.lat, e.latlng.lng));
      $('#geoBtn').addEventListener('click', ()=> map.locate({setView:true, maxZoom:16}));
      map.on('locationfound', e=> setMarker(e.latlng.lat, e.latlng.lng));

      // Save
      document.getElementById('saveBtn').addEventListener('click', async ()=>{
        const name=$('#name').value.trim();
        if(!name){ alert(I18N.t('msg.needName')); return; }
        const lat=parseFloat($('#latOut').textContent.replace(',','.'));
        const lng=parseFloat($('#lngOut').textContent.replace(',','.'));
        if(!Number.isFinite(lat)||!Number.isFinite(lng)){ alert(I18N.t('msg.needPos')); return; }

        const row = {
          id: `${slugify(name)}-${randomId()}`,
          name,
          address: $('#address').value.trim(),
          lat, lng,
          vegetarian: $('#vegOnly').checked,
          vegetarian_type: $$('.vegType:checked').map(i=>i.value).join(', '),
          meat: $('#meatOnly').checked,
          meat_types: $$('.meatType:checked').map(i=>i.value).join(', '),
          sauces: $('#saucesOnly').checked,
          sauce_types: $$('.sauceType:checked').map(i=>i.value).join(', '),
          homemade_bread: $('#breadOnly').checked,
          payment_cards: false,                // field exists in DB ‚Äì default off here
          price_kebap: toNum($('#pK').value),
          price_durum: toNum($('#pD').value),
          price_box:   toNum($('#pB').value),
          opening_days: $$('.dayFilter:checked').map(i=>i.value).join(','),
          rating_admin: null
        };

        try{
          const btn = document.getElementById('saveBtn');
          const old = btn.innerHTML;
          btn.disabled = true; btn.innerHTML = '‚è≥ ' + I18N.t('msg.saving');
          const { data, error } = await supa.from('shops').insert([row]).select('*').single();
          btn.disabled = false; btn.innerHTML = old;

          if(error){
            console.error('[Supabase] insert error:', error);
            alert(I18N.t('msg.error'));
            return;
          }
          console.log('[Supabase] inserted:', data);
          alert(I18N.t('msg.saved'));
          location.href='index.html';
        }catch(err){
          console.error(err);
          alert(I18N.t('msg.error'));
        }
      });

      refreshChips(); toggleSubs();
    });
  </script>
</body>
</html>
