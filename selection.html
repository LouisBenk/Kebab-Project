<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dönerd – Preisliste</title>

  <style>
    :root{
      --bg:#f0f2f5; --text:#0f172a; --muted:#64748b; --card:#ffffff;
      --ring:#e5e7eb; --chip:#eef2f7; --chipText:#0f172a;
      --accent:#fb923c; --accent-strong:#f97316;
      --shadow:0 10px 28px rgba(0,0,0,.16);
      --nav-pill-w:140px;
      --topbar-h: 64px; --gap-top: 16px;
    }
    @media (max-width:600px){ :root{ --topbar-h:56px; --gap-top:8px; } }

    html[data-theme="dark"]{
      --bg:#0b0f14; --text:#e5e7eb; --muted:#9aa4b2; --card:#0f172a;
      --ring:#1f2937; --chip:#0b1220; --chipText:#e5e7eb;
      --shadow:0 16px 40px rgba(0,0,0,.5);
    }
    html, body { margin:0; height:100%; background:var(--bg); color:var(--text); font-family: Arial, sans-serif; }
    button { font:inherit; }
    img{ max-width:100%; height:auto; }

    /* ===== Topbar (identical to map page) ===== */
    #navbar{
      position:fixed; top:0; left:0; right:0;
      height:var(--topbar-h);
      display:flex; align-items:center; justify-content:center;
      padding:0 8px; z-index:1000; background:transparent;
      backdrop-filter: blur(10px);
    }
    @media (max-width:600px){
      #navbar{ background:rgba(15,23,42,.88); border-bottom:1px solid var(--ring); }
      html[data-theme="light"] #navbar{ background:rgba(255,255,255,.88); }
    }
    .nav-inner{width:100%; max-width:1200px; display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; font-size:28px; padding-left:6px; flex:0 0 auto}
    .brand .dot{width:12px; height:12px; border-radius:50%; background:#ff385c; display:inline-block}

    .searchbar{flex:1; display:flex; align-items:center; background:var(--card); border-radius:999px; box-shadow:var(--shadow); padding:6px; min-width:240px; max-width:620px; border:1px solid var(--ring)}
    .search-seg{flex:1; display:flex; align-items:center; gap:10px; padding:10px 14px; border-radius:999px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .search-seg:hover{background:rgba(0,0,0,.04)}
    html[data-theme="dark"] .search-seg:hover{background:rgba(255,255,255,.05)}
    .seg-icon{width:20px; height:20px; display:inline-grid; place-items:center; border-radius:6px; background:#f3f4f6; font-size:14px}
    html[data-theme="dark"] .seg-icon{background:#111827; color:#e5e7eb}
    .seg-input{flex:1; display:flex; align-items:center; gap:8px; min-width:0}
    .seg-input input{width:100%; border:0; outline:0; background:transparent; color:var(--text); font:inherit}

    .right-actions{display:flex; align-items:center; gap:10px; margin-left:12px}
    .action-pill{display:flex; align-items:center; gap:8px; padding:8px 14px; background:var(--card); border:1px solid var(--ring); border-radius:14px; box-shadow:0 2px 8px rgba(0,0,0,.06); font-weight:700; white-space:nowrap; cursor:pointer; color:var(--text)}
    .action-pill:hover{background:rgba(0,0,0,.04)}
    html[data-theme="dark"] .action-pill:hover{background:rgba(255,255,255,.05)}
    .action-icon{width:18px; height:18px; display:inline-grid; place-items:center; border-radius:50%; background:#f3f4f6; font-size:12px; color:#374151}
    html[data-theme="dark"] .action-icon{background:#111827; color:#e5e7eb}

    /* Active pill highlight */
    .action-pill.is-active{ background:var(--accent); color:#000; border-color:transparent; box-shadow:0 6px 16px rgba(249,115,22,.35); }

    .lang-toggle{display:inline-flex; background:var(--card); border:1px solid var(--ring); border-radius:999px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .lang-toggle button{min-width:60px; padding:8px 12px; font-weight:800; border:0; background:transparent; cursor:pointer; line-height:1; color:var(--text)}
    .lang-toggle button+button{border-left:1px solid var(--ring)}
    .lang-toggle button.is-active{background:var(--accent); color:#000}

    #mobileMenuBtn{ display:none; }
    @media (max-width:600px){
      .brand{ font-size:20px; padding-left:2px; }
      .searchbar{ min-width:0; max-width:100%; padding:4px; border-radius:12px; }
      .search-seg{ padding:8px 10px; }
      .seg-icon{ width:18px; height:18px; font-size:12px; }
      .right-actions{ gap:6px; }
      .action-pill{ padding:8px 10px; }
      .action-pill span:last-child{ display:none; } /* hide text, keep icons on small screens */
      #mobileMenuBtn{ display:inline-block; }
    }

    /* ===== Page canvas (list view) ===== */
    .page{ padding-top: calc(var(--topbar-h) + var(--gap-top)); }
    .wrap{ display:flex; justify-content:center; padding:20px; }
    .card{ width:min(1100px,96vw); background:var(--card); border-radius:20px; box-shadow:var(--shadow); border:1px solid var(--ring); overflow:visible; }

    /* ===== Hero header ===== */
    .hero{
      position:relative; padding:22px 22px 18px;
      background:
        radial-gradient(1200px 400px at 80% -40%, rgba(251,146,60,.35), transparent 60%),
        radial-gradient(900px 300px   at 0%   0%, rgba(253,186,116,.25), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.86));
    }
    html[data-theme="dark"] .hero{
      background:
        radial-gradient(1200px 400px at 80% -40%, rgba(251,146,60,.25), transparent 60%),
        radial-gradient(900px 300px   at 0%   0%, rgba(253,186,116,.18), transparent 60%),
        linear-gradient(180deg, rgba(15,23,42,.92), rgba(15,23,42,.88));
    }
    .hero-top{ display:flex; align-items:center; gap:10px; }
    .pin{ width:28px; height:28px; display:grid; place-items:center; border-radius:8px; background:#fff; border:1px solid var(--ring); box-shadow:0 2px 8px rgba(0,0,0,.06); }
    html[data-theme="dark"] .pin{ background:#0b1220; }
    .title{ font-size:30px; font-weight:900; margin:0; }
    .subtitle{ color:var(--muted); margin:6px 0 0; }
    .hero-stats{ display:flex; flex-wrap:wrap; gap:8px; margin-top:14px; }
    .stat-pill{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px;
      border:1px solid var(--ring); border-radius:12px; background:var(--chip);
      font-weight:800; color:var(--chipText); font-size:13px;
    }

    /* ===== Top controls row ===== */
    .top-controls{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
      padding:12px 22px; border-top:1px solid var(--ring); background:var(--card);
    }
    .searchbar-inline{ display:flex; align-items:center; gap:8px; background:var(--chip); border:1px solid var(--ring); border-radius:12px; padding:8px 10px; min-width:240px; }
    .searchbar-inline input{ border:0; outline:0; background:transparent; color:var(--text); width:220px; }
    .sort-select{ border:1px solid var(--ring); background:var(--card); color:var(--text); border-radius:12px; padding:8px 12px; font-weight:800; }
    .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .small-pill{ display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border-radius:999px; background:var(--chip); border:1px solid var(--ring); font-weight:800; cursor:pointer; }
    .btn-ghost{ border:1px solid var(--ring); background:var(--card); color:var(--text); border-radius:12px; padding:8px 12px; font-weight:800; cursor:pointer; }

    /* ===== Meta & list ===== */
    .meta{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px 22px; color:var(--muted); font-size:13px; }
    .list{ display:grid; grid-template-columns:1fr; gap:12px; padding:0 22px 22px; }
    .item{
      display:grid; grid-template-columns: 92px 1fr; gap:12px;
      align-items:start; background:var(--card); border:1px solid var(--ring);
      border-radius:16px; padding:12px; box-shadow:0 1px 3px rgba(0,0,0,.06);
    }
    .thumb{ width:92px; height:92px; border-radius:12px; object-fit:cover; background:#0002; cursor:pointer; }
    .main{ display:grid; gap:6px; min-width:0 }
    .row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .item h4{ margin:0; font-size:16px; font-weight:900; line-height:1.2; }
    .line{ color:var(--muted); font-size:12px; }

    .price-pill{
      display:inline-flex; align-items:center; gap:6px;
      background:#f8fafc; color:#0f172a; border:1px solid var(--ring);
      border-radius:12px; padding:6px 10px; font-weight:800; font-size:13px;
    }
    html[data-theme="dark"] .price-pill{ background:#0b1220; color:#e5e7eb; }

    .rating-pill{ display:inline-flex; align-items:center; gap:6px; border-radius:999px; padding:6px 10px; font-weight:800; border:1px solid; }
    .rating-user{ background:#fff7ed; color:#7c2d12; border-color:#fed7aa; }
    html[data-theme="dark"] .rating-user{ background:#2a1709; color:#ffd2a1; border-color:#7a4b27; }
    .rating-admin{ background:#e0f2fe; color:#0c4a6e; border-color:#7dd3fc; }
    html[data-theme="dark"] .rating-admin{ background:#072534; color:#93c5fd; border-color:#1e3a8a; }

    .meta-pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--chip); color:var(--chipText); border:1px solid var(--ring); font-weight:800; font-size:12px; }
    .badge{ font-size:11px; padding:2px 6px; border-radius:999px; background:var(--chip); border:1px solid var(--ring); }
    .badge.min{ background:rgba(16,185,129,.15); border-color:rgba(16,185,129,.35); }
    .badge.max{ background:rgba(239,68,68,.15); border-color:rgba(239,68,68,.35); }

    .btn-nav{ padding:8px 12px; border:1px solid var(--ring); border-radius:999px; background:var(--card); font-weight:800; color:#0f172a; }
    html[data-theme="dark"] .btn-nav{ color:#e5e7eb; }

    .fav-btn{ display:inline-grid; place-items:center; width:34px; height:34px; border-radius:999px; border:1px solid var(--ring); background:var(--card); cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.08); color:#ef4444; }
    .fav-btn.on{ background:#fee2e2; border-color:#fecaca; }

    /* Empty */
    .empty{ padding:18px; margin:8px 22px 22px; border:1px dashed var(--ring); border-radius:12px; color:var(--muted); display:flex; align-items:center; gap:10px; }
    .empty button{ margin-left:auto; }

    /* Carousel modal */
    .ov{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:1200; }
    .ov.open{ display:flex; }
    .car{ width:min(900px,92vw); background:var(--card); color:var(--text); border:1px solid var(--ring); border-radius:14px; box-shadow:0 12px 30px rgba(0,0,0,.35); padding:10px; }
    .car-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .car-track{ position:relative; overflow:hidden; border-radius:10px; }
    .car-inner{ display:flex; transition:transform .25s ease; }
    .car-inner img{ width:min(900px,92vw); height:min(70vh,560px); object-fit:cover; flex:0 0 auto; }
    .car-controls{ display:flex; justify-content:space-between; margin-top:8px; }
    .car-btn{ border:1px solid var(--ring); background:var(--card); color:var(--text); padding:8px 12px; border-radius:10px; font-weight:900; cursor:pointer; }

    /* Toast (reuses from map page) */
    #donerdToast{
      position:fixed; left:50%; bottom:22px; transform:translateX(-50%);
      background:#111; color:#fff; border-radius:999px; padding:10px 14px;
      box-shadow:0 6px 18px rgba(0,0,0,.35); z-index:1400; display:none; font-weight:800
    }
    html[data-theme="dark"] #donerdToast{ background:#0f172a }
    #donerdToast.show{ display:block; animation:toastfade .25s ease both }
    @keyframes toastfade{ from{opacity:0; transform:translate(-50%,8px)} to{opacity:1; transform:translate(-50%,0)} }

    /* Print */
    @media print{
      #navbar, .hero, .top-controls, .btn-nav, .fav-btn { display:none !important; }
      .page{ padding-top:0; }
      .wrap{ padding:0; }
      .card{ border:0; box-shadow:none; }
      .item{ page-break-inside:avoid; }
    }

    @media (max-width:720px){
      .item{ grid-template-columns:72px 1fr; gap:10px; }
      .thumb{ width:72px; height:72px; }
    }
  </style>
</head>
<body>
  <!-- ===== Topbar (identical) ===== -->
  <div id="navbar">
    <div class="nav-inner">
      <div class="brand" aria-label="Dönerd">
        <span class="dot"></span><span>Dönerd</span>
      </div>

      <div class="searchbar" role="group" aria-label="Primary actions">
        <div class="search-seg" id="seg-looking">
          <span class="seg-icon" aria-hidden="true">🏠</span>
          <label class="seg-input" for="navSearchInput">
            <input id="navSearchInput" type="text" placeholder="Suche nach Name, Straße, Tags … (z.B. falafel, scharf)" aria-label="Kebab-Läden suchen" />
          </label>
        </div>
      </div>

      <div class="right-actions">
        <button class="action-pill" id="filterBtn" title="Filter" onclick="location.href='index.html'"><span class="action-icon">⚙️</span><span>Filter</span></button>
        <button class="action-pill" id="themeBtn" title="Dark mode">
          <span class="action-icon" id="themeIcon">🌙</span><span id="themeText">Dark</span>
        </button>
        <button class="action-pill" onclick="location.href='add-shop.html'" title="Shop hinzufügen"><span class="action-icon">➕</span><span>Shop hinzufügen</span></button>
        <button class="action-pill" onclick="location.href='feedback.html'" title="Feedback"><span class="action-icon">💬</span><span>Feedback</span></button>
        <!-- Active highlight on Preisliste -->
        <button class="action-pill is-active" aria-current="page" onclick="location.href='selection.html'" title="Preisliste"><span class="action-icon">📋</span><span>Preisliste</span></button>
        <button class="action-pill" onclick="location.href='about.html'" title="Über mich"><span class="action-icon">👤</span><span>Über mich</span></button>

        <div class="lang-toggle" role="group" aria-label="Language">
          <button class="action-pill" id="loginBtn" title="Login">
            <span class="action-icon">🔑</span><span id="loginText">Login</span>
          </button>
          <button type="button" data-lang="de" aria-pressed="true" class="is-active">DE</button>
          <button type="button" data-lang="en" aria-pressed="false">EN</button>
        </div>
      </div>

      <button id="mobileMenuBtn" class="action-pill" style="display:none">☰</button>
      <div id="mobileMenu" class="hidden" style="position:absolute;top:52px;right:8px;background:var(--card);border:1px solid var(--ring);border-radius:12px;box-shadow:var(--shadow);z-index:2000;display:none">
        <button onclick="location.href='add-shop.html'">➕ Shop hinzufügen</button>
        <button onclick="location.href='feedback.html'">💬 Feedback</button>
        <button onclick="location.href='selection.html'">📋 Preisliste</button>
        <button onclick="location.href='about.html'">👤 Über mich</button>
      </div>
    </div>
  </div>

  <!-- ===== Page ===== -->
  <div class="page">
    <div class="wrap">
      <div class="card">
        <!-- Hero -->
        <div class="hero">
          <div class="hero-top">
            <span class="pin">🍢</span>
            <div>
              <h1 class="title" data-i18n="sel.title">Preisliste</h1>
              <p class="subtitle" data-i18n="sel.subtitle">Liste aller Läden mit Filtern für günstigste/teuerste Kebap, Dürüm, Box & Bewertung.</p>
            </div>
          </div>
          <div class="hero-stats" id="heroStats"></div>
        </div>

        <!-- Top controls -->
        <div class="top-controls">
          <div class="searchbar-inline" role="search">
            <span>🔎</span>
            <input id="q" type="search" placeholder="Suche Name, Straße …" />
          </div>

          <div class="toolbar">
            <select id="sort" class="sort-select" title="Sortieren">
              <option value="rating_desc">⭐ Rating ↓</option>
              <option value="rating_asc">⭐ Rating ↑</option>
              <option value="kebap_asc">🥙 Kebap € ↑</option>
              <option value="kebap_desc">🥙 Kebap € ↓</option>
              <option value="durum_asc">🌯 Dürüm € ↑</option>
              <option value="durum_desc">🌯 Dürüm € ↓</option>
              <option value="box_asc">📦 Box € ↑</option>
              <option value="box_desc">📦 Box € ↓</option>
              <option value="name_asc">A → Z</option>
              <option value="name_desc">Z → A</option>
            </select>

            <button id="favOnly" class="small-pill" aria-pressed="false" title="Nur Favoriten">
              ❤️ <span>Favoriten</span>
            </button>

            <button id="exportCsv" class="btn-ghost" title="CSV exportieren">⬇️ CSV</button>
            <button id="printBtn" class="btn-ghost" title="Drucken">🖨️ Print</button>
          </div>
        </div>

        <div class="meta"><span id="count">0</span></div>
        <div id="list" class="list"></div>

        <div id="empty" class="empty" style="display:none">
          <span>😕 Keine Treffer.</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Carousel modal -->
  <div id="ov" class="ov" aria-hidden="true">
    <div class="car" role="dialog" aria-modal="true" aria-labelledby="carTitle">
      <div class="car-head">
        <div id="carTitle" style="font-weight:900">Fotos</div>
        <button id="carClose" class="car-btn">✖</button>
      </div>
      <div class="car-track">
        <div id="carInner" class="car-inner"></div>
      </div>
      <div class="car-controls">
        <button id="carPrev" class="car-btn">⟵</button>
        <button id="carNext" class="car-btn">⟶</button>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- i18n -->
  <script>
    const DICTS={de:{
      nav:{map:"Karte", add:"Shop hinzufügen", feedback:"Feedback", about:"Über mich", filter:"Filter", selection:"Preisliste"},
      sel:{title:"Preisliste", subtitle:"Liste aller Läden mit Filtern für günstigste/teuerste Kebap, Dürüm, Box & Bewertung.", all:"Alle", min:"Günstigste", max:"Teuerste", nav:"Navigieren", shops:"Läden"},
      price:{kebap:"Kebap €", durum:"Dürüm €", box:"Box €"},
      rating:{user:"Nutzer", admin:"Admin"},
      tags:{veg:"Vegetarisch", cards:"Kartenzahlung"},
      stats:{shops:"Läden", kebapFrom:"Kebap ab", durumFrom:"Dürüm ab", boxFrom:"Box ab"},
      hints:{range:"Spanne: Kebap {kmin}–{kmax}, Dürüm {dmin}–{dmax}, Box {bmin}–{bmax}"}
    }, en:{
      nav:{map:"Map", add:"Add Shop", feedback:"Feedback", about:"About me", filter:"Filter", selection:"Price list"},
      sel:{title:"Price list", subtitle:"All shops with filters for cheapest/most expensive Kebap, Durum, Box & rating.", all:"All", min:"Cheapest", max:"Most expensive", nav:"Navigate", shops:"shops"},
      price:{kebap:"Kebap €", durum:"Durum €", box:"Kebab Box €"},
      rating:{user:"User", admin:"Admin"},
      tags:{veg:"Vegetarian", cards:"Card payment"},
      stats:{shops:"shops", kebapFrom:"Kebap from", durumFrom:"Durum from", boxFrom:"Box from"},
      hints:{range:"Range: Kebap {kmin}–{kmax}, Durum {dmin}–{dmax}, Box {bmin}–{bmax}"}
    }};
    const I18N=(()=>{let lang='de',dict=DICTS.de;
      const get=(o,p)=>p.split('.').reduce((a,k)=>a&&a[k]!=null?a[k]:undefined,o);
      const t=(k,fb)=>get(dict,k)??fb??k;
      function apply(){
        document.querySelectorAll('[data-i18n]').forEach(el=>el.textContent=t(el.dataset.i18n,el.textContent.trim()));
        document.documentElement.lang=lang;
        document.querySelectorAll('.lang-toggle [data-lang]').forEach(b=>{
          const on=b.dataset.lang===lang; b.classList.toggle('is-active',on); b.setAttribute('aria-pressed',on?'true':'false');
        });
      }
      function set(l){ lang=(l==='en')?'en':'de'; dict=DICTS[lang]; localStorage.setItem('lang',lang); apply(); }
      function init(){
        const stored=localStorage.getItem('lang'); const guess=(navigator.language||'').slice(0,2);
        set(stored || (['de','en'].includes(guess)?guess:'de'));
        document.addEventListener('click',e=>{
          const b=e.target.closest('.lang-toggle [data-lang]'); if(b) set(b.dataset.lang);
        });
      }
      function fmt(s,obj){ return String(s||'').replace(/\{(\w+)\}/g,(_,k)=> (obj&&k in obj)?obj[k]:''); }
      return {init,t,fmt};
    })();
    document.addEventListener('DOMContentLoaded', I18N.init);
  </script>

  <!-- Dark mode + topbar glue -->
  <script>
    (function(){
      const themeBtn  = document.getElementById('themeBtn');
      const themeIcon = document.getElementById('themeIcon');
      const themeText = document.getElementById('themeText');
      function setTheme(mode){
        document.documentElement.setAttribute('data-theme', mode);
        localStorage.setItem('theme', mode);
        themeIcon.textContent = mode === 'dark' ? '🌞' : '🌙';
        themeText.textContent = mode === 'dark' ? 'Light' : 'Dark';
      }
      const stored = localStorage.getItem('theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      setTheme(stored || (prefersDark ? 'dark' : 'light'));
      themeBtn.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme') || 'light';
        setTheme(current === 'dark' ? 'light' : 'dark');
      });

      // Mobile menu toggle (same behavior as map page)
      const mobileBtn = document.getElementById('mobileMenuBtn');
      const mobileMenu = document.getElementById('mobileMenu');
      mobileBtn?.addEventListener('click', ()=> {
        mobileMenu.style.display = (mobileMenu.style.display === 'block') ? 'none' : 'block';
      });

      // Navbar search -> mirror into inline list search
      const navInput = document.getElementById('navSearchInput');
      const listInput = document.getElementById('q');
      navInput?.addEventListener('input', ()=> {
        if(listInput){ listInput.value = navInput.value; listInput.dispatchEvent(new Event('input')); }
      });
    })();
  </script>

  <!-- ===== Auth (identical behavior to map page) ===== -->
  <script>
    const SUPABASE_URL  = 'https://bcxeaxhhhvagpvomtsyi.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjeGVheGhoaHZhZ3B2b210c3lpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNTUxMzcsImV4cCI6MjA3MDgzMTEzN30.HCnWgapZrDY4RIgdXM5eh2UkslFpSSuJwEUszZHtp0w';
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    let currentUser=null;
    let myFavs=new Set();

    function showToast(msg, ms=4200){
      const t = document.getElementById('donerdToast');
      if(!t) return alert(msg);
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), ms);
    }

    async function setUser(user){
      currentUser = user;
      const btn = document.getElementById('loginBtn');
      const txt = document.getElementById('loginText');

      if (user) {
        // Behave as "Profile"
        btn.title = 'Profil';
        const first = user.user_metadata?.first_name;
        txt.textContent = first ? `Hi, ${first}` : 'Profil';
        await loadFavorites();
      } else {
        btn.title = 'Login';
        txt.textContent = 'Login';
        myFavs.clear();
      }
      try { render(); } catch (_) {}
    }

    async function loadFavorites(){
      if(!currentUser){ myFavs.clear(); return; }
      const { data, error } = await supa.from('favorites').select('shop_id').eq('user_id', currentUser.id);
      if(!error && Array.isArray(data)) myFavs = new Set(data.map(r=>String(r.shop_id)));
    }

    async function toggleFavorite(shopId){
      if(!currentUser){
        alert(document.documentElement.lang==='de'
          ? 'Bitte einloggen, um Favoriten zu speichern.'
          : 'Please log in to save favorites.');
        return;
      }
      const id=String(shopId);
      if(myFavs.has(id)){
        await supa.from('favorites').delete().eq('user_id', currentUser.id).eq('shop_id', id);
        myFavs.delete(id);
      }else{
        await supa.from('favorites').insert([{ user_id: currentUser.id, shop_id: id }]);
        myFavs.add(id);
      }
      render();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const loginBtn  = document.getElementById('loginBtn');
      const authOv    = document.getElementById('authOverlay');
      const authClose = document.getElementById('authClose');
      const authEmail = document.getElementById('authEmail');
      const authPass  = document.getElementById('authPassword');
      const authErr   = document.getElementById('authError');
      const btnIn     = document.getElementById('authSignIn');
      const btnUp     = document.getElementById('authSignUp');
      const btnGH     = document.getElementById('authGitHub');

      function openAuth(){
        authErr.textContent = ''; authErr.style.color='';
        authEmail.value = ''; authPass.value = '';
        authOv.style.display = 'flex';
      }
      function closeAuth(){ authOv.style.display = 'none'; }

      loginBtn?.addEventListener('click', async () => {
        const { data } = await supa.auth.getUser();
        if (data?.user) { window.location.href = 'profile.html'; return; }
        openAuth();
      });
      authClose?.addEventListener('click', closeAuth);
      authOv?.addEventListener('click', (e)=>{ if(e.target===authOv) closeAuth(); });

      btnGH?.addEventListener('click', async ()=> {
        const redirectTo = location.origin;
        await supa.auth.signInWithOAuth({ provider:'github', options:{ redirectTo, scopes:'read:user user:email' }});
      });

      async function signInEmail(){
        authErr.textContent = '';
        const email = (authEmail.value||'').trim();
        const password = authPass.value||'';
        if (!email || !password) { authErr.textContent = 'Bitte E-Mail und Passwort eingeben.'; return; }
        const { error } = await supa.auth.signInWithPassword({ email, password });
        if (error) { authErr.textContent = error.message; return; }
        const { data:{ session } } = await supa.auth.getSession();
        await handleSession(session);
        closeAuth(); try{ showToast('✅ Eingeloggt'); }catch(_){}
      }
      btnIn?.addEventListener('click', signInEmail);

      // Switch to signup
      const signupOv    = document.getElementById('signupOverlay');
      const signupClose = document.getElementById('signupClose');
      const signupBtn   = document.getElementById('signupSubmit');

      document.getElementById('authSignUp')?.addEventListener('click', () => {
        authOv.style.display = 'none';
        signupOv.style.display = 'flex';
      });
      signupClose?.addEventListener('click', () => { signupOv.style.display = 'none'; });

      function togglePassword(inputId, btnId){
        const input = document.getElementById(inputId);
        const btn   = document.getElementById(btnId);
        if (input && btn){
          btn.type = 'button';
          btn.addEventListener('click', (e)=>{ e.preventDefault(); input.type = input.type === 'password' ? 'text' : 'password'; });
        }
      }
      togglePassword('authPassword','toggleLoginPassword');
      togglePassword('signupPassword','toggleSignupPassword');
      togglePassword('signupPassword2','toggleSignupPassword2');

      async function doSignup(){
        const email     = (document.getElementById('signupEmail').value||'').trim();
        const password  = document.getElementById('signupPassword').value||'';
        const password2 = document.getElementById('signupPassword2').value||'';
        const first     = document.getElementById('signupName').value||'';
        const last      = document.getElementById('signupSurname').value||'';
        const age       = parseInt(document.getElementById('signupAge').value,10)||null;
        const err       = document.getElementById('authErrorSignup');

        err.style.color = '#ef4444'; err.textContent = '';
        if(!email || !password || !password2 || !first || !last || !age){ err.textContent = 'Alle Felder ausfüllen.'; return; }
        if(password !== password2){ err.textContent = 'Passwörter stimmen nicht überein.'; return; }

        const { error } = await supa.auth.signUp({ email, password, options:{ data:{ first_name:first, last_name:last, age } }});
        if(error){ err.textContent = error.message; return; }
        err.style.color = '#16a34a'; err.textContent = 'Registriert. Bitte E-Mail bestätigen.';
        signupOv.style.display = 'none';
        showToast('📨 Bitte bestätige deine E-Mail. Danach kannst du dich einloggen.');
      }
      signupBtn?.addEventListener('click', doSignup);
    });

    async function handleSession(session){
      const user = session?.user ?? null;
      if (user) {
        try {
          const display =
            user.user_metadata?.user_name ||
            user.user_metadata?.full_name ||
            (user.email ? user.email.split('@')[0] : 'User');
          await supa.from('profiles').upsert(
            { id: user.id, display_name: display },
            { onConflict: 'id' }
          );
        } catch(e){}
      }
      await setUser(user);
    }

    (async () => {
      const { data:{ session } } = await supa.auth.getSession();
      await handleSession(session);
      supa.auth.onAuthStateChange(async (_event, session)=>{ await handleSession(session); });
    })();
  </script>

  <!-- ===== List app logic (unchanged behavior) ===== -->
  <script>
    let shops=[];
    const state={ q:'', sort:'rating_desc', favOnly:false };
    const mins={kebap:Infinity,durum:Infinity,box:Infinity};
    const maxs={kebap:-Infinity,durum:-Infinity,box:-Infinity};

    const num = v => (typeof v==='number' && isFinite(v)) ? v : NaN;
    const fmt = v => (typeof v==='number' && isFinite(v) && v>0) ? `€${v.toFixed(2)}` : '–';
    const fmtRating = r => (typeof r==='number' && isFinite(r)) ? r.toFixed(1) : '—';

    function computeExtrema(){
      ['kebap','durum','box'].forEach(k=>{mins[k]=Infinity; maxs[k]=-Infinity;});
      (shops||[]).forEach(s=>{
        const p=s.prices||{};
        ['kebap','durum','box'].forEach(k=>{
          const v=num(p[k]);
          if(!isNaN(v) && v>0){ mins[k]=Math.min(mins[k],v); maxs[k]=Math.max(maxs[k],v); }
        });
      });
    }

    function syncFavToggle(){
      const b=document.getElementById('favOnly');
      b.setAttribute('aria-pressed', state.favOnly ? 'true':'false');
      if(!currentUser) b.title='Login nötig für Favoriten';
    }
    function renderHeroStats(){
      const root = document.getElementById('heroStats');
      const kMin = isFinite(mins.kebap) ? fmt(mins.kebap) : '–';
      const dMin = isFinite(mins.durum) ? fmt(mins.durum) : '–';
      const bMin = isFinite(mins.box)   ? fmt(mins.box)   : '–';
      const count = (shops||[]).length;
      root.innerHTML = `
        <span class="stat-pill">📍 ${count} ${I18N.t('sel.shops')}</span>
        <span class="stat-pill">🥙 ${I18N.t('stats.kebapFrom')} ${kMin}</span>
        <span class="stat-pill">🌯 ${I18N.t('stats.durumFrom')} ${dMin}</span>
        <span class="stat-pill">📦 ${I18N.t('stats.boxFrom')} ${bMin}</span>
      `;
    }

    function passes(s){
      if(state.favOnly && !myFavs.has(String(s.id))) return false;
      if(state.q){
        const hay=[s.name||'', s.address||''].join(' ').toLowerCase();
        if(!hay.includes(state.q.toLowerCase())) return false;
      }
      return true;
    }

    const sorters={
      rating_desc:(a,b)=>((isFinite(b.rating)?b.rating:-1)-(isFinite(a.rating)?a.rating:-1)) || (a.name||'').localeCompare(b.name||''),
      rating_asc :(a,b)=>((isFinite(a.rating)?a.rating:999)-(isFinite(b.rating)?b.rating:999)) || (a.name||'').localeCompare(b.name||''),
      kebap_asc :(a,b)=>((a.prices.kebap??999)-(b.prices.kebap??999))|| (a.name||'').localeCompare(b.name||''),
      kebap_desc:(a,b)=>((b.prices.kebap??-1)-(a.prices.kebap??-1)) || (a.name||'').localeCompare(b.name||''),
      durum_asc :(a,b)=>((a.prices.durum??999)-(b.prices.durum??999))|| (a.name||'').localeCompare(b.name||''),
      durum_desc:(a,b)=>((b.prices.durum??-1)-(a.prices.durum??-1)) || (a.name||'').localeCompare(b.name||''),
      box_asc   :(a,b)=>((a.prices.box??999)-(b.prices.box??999))    || (a.name||'').localeCompare(b.name||''),
      box_desc  :(a,b)=>((b.prices.box??-1)-(a.prices.box??-1))      || (a.name||'').localeCompare(b.name||''),
      name_asc  :(a,b)=>(a.name||'').localeCompare(b.name||''),
      name_desc :(a,b)=>(b.name||'').localeCompare(a.name||'')
    };

    function writeURL(){
      const p=new URLSearchParams();
      if(state.q) p.set('q',state.q);
      if(state.sort!=='rating_desc') p.set('sort',state.sort);
      if(state.favOnly) p.set('fav','1');
      const q='?'+p.toString();
      history.replaceState(null,'',q.length>1?q:' ');
    }
    function readURL(){
      const p=new URLSearchParams(location.search);
      state.q = p.get('q')||'';
      state.sort = p.get('sort')||state.sort;
      state.favOnly = p.get('fav')==='1';
    }

    function render(){
      writeURL();

      const list=document.getElementById('list');
      const rows = (shops||[]).filter(passes).slice().sort(sorters[state.sort]||sorters.rating_desc);

      document.getElementById('count').textContent = `${rows.length} ${I18N.t('sel.shops')}`;
      document.getElementById('empty').style.display = rows.length? 'none':'flex';
      list.innerHTML='';

      rows.forEach(s=>{
        const k=num(s?.prices?.kebap), d=num(s?.prices?.durum), b=num(s?.prices?.box);
        const img = (s.image_urls && s.image_urls.length)
          ? s.image_urls[0]
          : `https://picsum.photos/seed/${encodeURIComponent(s.name||s.id)}/400/400`;

        const userPill  = Number.isFinite(s.rating_avg)
          ? `<span class="rating-pill rating-user">★ ${fmtRating(s.rating_avg)}${Number.isFinite(s.rating_count)?` (${s.rating_count})`:''}</span>` : '';
        const adminPill = Number.isFinite(s.rating_admin)
          ? `<span class="rating-pill rating-admin">★ ${fmtRating(s.rating_admin)}</span>` : '';

        const veg  = s.vegetarian ? ` · 🥬 ${I18N.t('tags.veg')}` : '';
        const card = s.card       ? ` · 💳 ${I18N.t('tags.cards')}` : '';

        const favOn = myFavs.has(String(s.id)) ? 'on' : '';

        const el=document.createElement('div'); el.className='item';
        el.innerHTML=`
          <img class="thumb" src="${img}" alt="" data-id="${s.id}">
          <div class="main">
            <div class="row">
              <h4 style="margin-right:auto">${s.name||'–'}</h4>
              ${userPill}${adminPill}
              <button class="fav-btn ${favOn}" data-fav="${s.id}" title="Favorit">❤</button>
            </div>
            <div class="line">${fmt(k)} · ${fmt(d)} · ${fmt(b)} ${veg}${card}</div>
            <div class="line">${s.address||''}</div>

            <div class="row" style="margin-top:4px">
              <span class="price-pill">🥙 ${I18N.t('price.kebap')} ${fmt(k)} ${(!isNaN(k)&&k>0&&k===mins.kebap)?'<span class="badge min">min</span>':''} ${(!isNaN(k)&&k>0&&k===maxs.kebap)?'<span class="badge max">max</span>':''}</span>
              <span class="price-pill">🌯 ${I18N.t('price.durum')} ${fmt(d)} ${(!isNaN(d)&&d>0&&d===mins.durum)?'<span class="badge min">min</span>':''} ${(!isNaN(d)&&d>0&&d===maxs.durum)?'<span class="badge max">max</span>':''}</span>
              <span class="price-pill">📦 ${I18N.t('price.box')} ${fmt(b)} ${(!isNaN(b)&&b>0&&b===mins.box)?'<span class="badge min">min</span>':''} ${(!isNaN(b)&&b>0&&b===maxs.box)?'<span class="badge max">max</span>':''}</span>

              <a class="btn-nav" style="margin-left:auto" href="https://www.google.com/maps?q=${s.lat},${s.lng}" target="_blank" rel="noopener">${I18N.t('sel.nav')}</a>
              <a class="btn-nav" href="index.html?focus=${encodeURIComponent(s.id)}" title="In Dönerd Karte öffnen">🗺️ Karte</a>
              <button class="btn-nav photos" data-id="${s.id}" title="Fotos ansehen">🖼️ Fotos</button>
            </div>
          </div>`;
        list.appendChild(el);
      });

      list.querySelectorAll('.fav-btn').forEach(btn=>{
        btn.addEventListener('click',()=> toggleFavorite(btn.getAttribute('data-fav')));
      });
      list.querySelectorAll('.photos').forEach(b=>{
        b.addEventListener('click',()=> openCarousel(b.getAttribute('data-id')));
      });
      list.querySelectorAll('.thumb').forEach(img=>{
        img.addEventListener('click',()=> openCarousel(img.getAttribute('data-id')));
      });
    }

    // Carousel
    let carIndex=0, carImages=[];
    const ov=document.getElementById('ov');
    const carInner=document.getElementById('carInner');
    function openCarousel(id){
      const s = shops.find(x=>String(x.id)===String(id));
      if(!s) return;
      carImages = (s.image_urls&&s.image_urls.length)? s.image_urls
                 : [`https://picsum.photos/seed/${encodeURIComponent(s.name||s.id)}/1200/800`];
      carIndex=0;
      document.getElementById('carTitle').textContent = s.name || 'Fotos';
      carInner.innerHTML = carImages.map(u=>`<img src="${u}" alt="">`).join('');
      updateCarousel();
      ov.classList.add('open'); ov.setAttribute('aria-hidden','false');
    }
    function updateCarousel(){
      const w=carInner.querySelector('img')?.getBoundingClientRect().width || 800;
      carInner.style.transform = `translateX(${-carIndex*w}px)`;
    }
    document.getElementById('carPrev').onclick = ()=>{ carIndex=(carIndex-1+carImages.length)%carImages.length; updateCarousel(); };
    document.getElementById('carNext').onclick = ()=>{ carIndex=(carIndex+1)%carImages.length; updateCarousel(); };
    document.getElementById('carClose').onclick = ()=>{ ov.classList.remove('open'); ov.setAttribute('aria-hidden','true'); };
    ov.addEventListener('click',(e)=>{ if(e.target===ov) document.getElementById('carClose').click(); });
    window.addEventListener('keydown',(e)=>{ if(!ov.classList.contains('open')) return;
      if(e.key==='ArrowLeft') document.getElementById('carPrev').click();
      if(e.key==='ArrowRight') document.getElementById('carNext').click();
      if(e.key==='Escape') document.getElementById('carClose').click();
    });

    // Export & print
    document.getElementById('exportCsv').addEventListener('click', ()=>{
      const header=['id','name','address','lat','lng','kebap','durum','box','rating'];
      const rows=(shops||[]).filter(passes).map(s=>[
        s.id, `"${(s.name||'').replace(/"/g,'""')}"`, `"${(s.address||'').replace(/"/g,'""')}"`,
        s.lat, s.lng, s.prices.kebap??'', s.prices.durum??'', s.prices.box??'',
        (isFinite(s.rating)?s.rating:'')
      ].join(','));
      const csv=[header.join(','), ...rows].join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='donerd-preisliste.csv'; a.click();
      URL.revokeObjectURL(a.href);
    });
    document.getElementById('printBtn').addEventListener('click', ()=> window.print());

    // Inputs
    document.getElementById('q').addEventListener('input', (e)=>{ state.q=e.target.value.trim(); render(); });
    document.getElementById('sort').addEventListener('change', (e)=>{ state.sort=e.target.value; render(); });
    document.getElementById('favOnly').addEventListener('click', ()=>{ state.favOnly=!state.favOnly; syncFavToggle(); render(); });

    // Data load
    async function load(){
      try{
        const { data, error } = await supa
          .from('shops')
          .select('id,name,address,lat,lng,price_kebap,price_durum,price_box,vegetarian,payment_cards,image_urls,rating_admin,rating_avg,rating_count')
          .order('name', { ascending: true });

        if(error) throw error;

        shops = (data||[]).map(r => {
          const rating_admin = Number.isFinite(r.rating_admin) ? r.rating_admin : null;
          const rating_avg   = Number.isFinite(r.rating_avg) ? r.rating_avg : null;
          const rating_count = Number.isFinite(r.rating_count) ? r.rating_count : null;
          const rating_effective = (rating_avg!=null) ? rating_avg : rating_admin;

          const imgs = Array.isArray(r.image_urls) ? r.image_urls : (r.image_urls ? [r.image_urls] : []);

          return {
            id: r.id,
            name: r.name,
            address: r.address,
            lat: r.lat, lng: r.lng,
            prices: { kebap: r.price_kebap, durum: r.price_durum, box: r.price_box },
            vegetarian: !!r.vegetarian,
            card: !!r.payment_cards,
            image_urls: imgs,
            rating_admin, rating_avg, rating_count,
            rating: rating_effective
          };
        });

        computeExtrema();
        renderHeroStats();
        render();
      }catch(err){
        console.error('[selection] load error:', err);
        document.getElementById('list').innerHTML =
          '<div class="subtitle">Fehler beim Laden aus Supabase.</div>';
      }
    }

    (async function init(){
      const { data:{ session } } = await supa.auth.getSession();
      await (async s=>{ // keep active user and favorites in sync
        const user = s?.user ?? null;
        await setUser(user);
      })(session);
      supa.auth.onAuthStateChange(async (_e, session)=>{ await setUser(session?.user ?? null); });

      readURL();
      document.getElementById('q').value = state.q;
      document.getElementById('sort').value = state.sort;
      syncFavToggle();

      await load();
    })();
  </script>

  <!-- ===== Auth Modals (same components as map page) ===== -->
  <div id="authOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1300">
    <div id="authModal" role="dialog" aria-modal="true" aria-labelledby="authTitle"
        style="width:min(420px,92vw);background:var(--card);color:var(--text);border:1px solid var(--ring);
              border-radius:14px;box-shadow:0 12px 30px rgba(0,0,0,.35);padding:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px">
        <div id="authTitle" style="font-weight:900;font-size:18px">Anmelden</div>
        <button id="authClose" class="rate-btn" style="background:#e5e7eb;color:#111;border-radius:999px;padding:6px 10px;font-weight:800">✖</button>
      </div>

      <div style="display:grid;gap:10px">
        <input id="authEmail" type="email" placeholder="E-Mail" autocomplete="email"
              style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);background:transparent;color:var(--text);font:inherit" />

        <div style="position:relative">
          <input id="authPassword" type="password" placeholder="Passwort"
                 style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);background:transparent;color:var(--text);font:inherit" />
          <button id="toggleLoginPassword" type="button"
                  style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none">👁</button>
        </div>

        <div id="authError" style="min-height:18px;color:#ef4444;font-weight:700;font-size:12px"></div>

        <div style="display:flex;gap:8px">
          <button id="authSignIn" class="rate-btn" style="flex:1;background:var(--accent);color:#000;border:0;border-radius:999px;padding:8px 14px;font-weight:800">Einloggen</button>
          <button id="authSignUp" class="rate-btn" style="flex:1;background:#e5e7eb;color:#111;border:0;border-radius:999px;padding:8px 14px;font-weight:800">Konto erstellen</button>
        </div>

        <div style="display:flex;align-items:center;gap:10px;margin:6px 0">
          <div style="height:1px;background:var(--ring);flex:1"></div>
          <small style="opacity:.8;font-weight:800">oder</small>
          <div style="height:1px;background:var(--ring);flex:1"></div>
        </div>

        <button id="authGitHub" class="rate-btn" style="width:100%;background:#111;color:#fff;border:0;border-radius:999px;padding:8px 14px;font-weight:800">
          Mit GitHub fortfahren
        </button>
      </div>
    </div>
  </div>

  <div id="signupOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1300">
    <div id="signupModal" role="dialog" aria-modal="true" aria-labelledby="signupTitle"
        style="width:min(420px,92vw);background:var(--card);color:var(--text);border:1px solid var(--ring);
              border-radius:14px;box-shadow:0 12px 30px rgba(0,0,0,.35);padding:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px">
        <div id="signupTitle" style="font-weight:900;font-size:18px">Konto erstellen</div>
        <button id="signupClose" class="rate-btn" style="background:#e5e7eb;color:#111;border-radius:999px;padding:6px 10px;font-weight:800">✖</button>
      </div>

      <div style="display:grid;gap:10px">
        <input id="signupName"     type="text"     placeholder="Vorname"    style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);background:transparent;color:var(--text);font:inherit" />
        <input id="signupSurname"  type="text"     placeholder="Nachname"   style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);background:transparent;color:var(--text);font:inherit" />
        <input id="signupAge"      type="number"   placeholder="Alter"      style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);background:transparent;color:var(--text);font:inherit" />
        <input id="signupEmail"    type="email"    placeholder="E-Mail"     style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);background:transparent;color:var(--text);font:inherit" />

        <div style="position:relative">
          <input id="signupPassword"  type="password" placeholder="Passwort"
                 style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);background:transparent;color:var(--text);font:inherit" />
          <button id="toggleSignupPassword" type="button"
                  style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none">👁</button>
        </div>

        <div style="position:relative">
          <input id="signupPassword2" type="password" placeholder="Passwort wiederholen"
                 style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);background:transparent;color:var(--text);font:inherit" />
          <button id="toggleSignupPassword2" type="button"
                  style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none">👁</button>
        </div>

        <div id="authErrorSignup" style="min-height:18px;color:#ef4444;font-weight:700;font-size:12px"></div>

        <button id="signupSubmit" class="rate-btn" style="width:100%;background:var(--accent);color:#000;border:0;border-radius:999px;padding:8px 14px;font-weight:800">Konto erstellen</button>
      </div>
    </div>
  </div>

  <!-- Toast element -->
  <div id="donerdToast" role="status" aria-live="polite"></div>
</body>
</html>
