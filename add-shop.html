<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>D√∂nerd ‚Äì Shop hinzuf√ºgen</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    :root{
      --bg:#f0f0f0; --text:#111; --muted:#6b7280; --card:#ffffff;
      --ring:#e5e7eb; --chip:#eef0f3; --chipText:#0f172a;
      --accent:#fb923c; --accent-strong:#f97316;
      --shadow:0 8px 24px rgba(0,0,0,.14);
      --topbar-h:64px;
    }
    @media (max-width:600px){ :root{ --topbar-h:56px } }

    html, body { margin:0; height:100%; background:var(--bg); color:var(--text); font-family:Arial, sans-serif; }
    button{font:inherit}

    /* ===== Unified top bar ===== */
    #navbar{
      position:sticky; top:0; left:0; right:0; height:var(--topbar-h);
      display:flex; align-items:center; justify-content:center; padding:0 8px; z-index:1000;
      background:rgba(255,255,255,.9); backdrop-filter: blur(10px); border-bottom:1px solid var(--ring);
    }
    html[data-theme="dark"] #navbar{ background:rgba(15,23,42,.88); }
    .nav-inner{width:100%;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;font-size:28px;padding-left:6px;flex:0 0 auto}
    .brand .dot{width:12px;height:12px;border-radius:50%;background:#ff385c;display:inline-block}
    .right-actions{display:flex;align-items:center;gap:10px;margin-left:auto}
    .action-pill{display:flex;align-items:center;gap:8px;padding:8px 14px;background:var(--card);border:1px solid var(--ring);border-radius:999px;box-shadow:0 2px 8px rgba(0,0,0,.06);font-weight:700;white-space:nowrap;cursor:pointer;color:var(--text)}
    .action-pill:hover{background:rgba(0,0,0,.04)}
    .action-pill.is-active{background:var(--accent); color:#000; box-shadow:0 6px 16px rgba(249,115,22,.35)}
    /* Burger hidden by default; show only on small screens */
#mobileMenuBtn{ display:none; }

/* Mobile dropdown (fixed) */
#mobileMenu{
  position:fixed;
  top:var(--topbar-h);
  right:8px;
  background:var(--card);
  color:var(--text);
  border:1px solid var(--ring);
  border-radius:12px;
  box-shadow:var(--shadow);
  z-index:2200;
}
#mobileMenu.hidden{ display:none; }

#mobileMenu .item{
  display:block; width:100%;
  padding:10px 12px;
  border:0; background:transparent;
  text-align:left; font:inherit; color:inherit;
  cursor:pointer;
}
#mobileMenu .item:hover{ background:rgba(0,0,0,.04); }
html[data-theme="dark"] #mobileMenu .item:hover{ background:rgba(255,255,255,.06); }

/* Phone layout: hide the full right-actions except the burger, show burger */
@media (max-width:600px){
  #mobileMenuBtn{ display:inline-flex; }
  .right-actions > *:not(#mobileMenuBtn){ display:none; }
}

    .action-icon{width:18px;height:18px;display:inline-grid;place-items:center;border-radius:50%;background:#f3f4f6;font-size:12px;color:#374151}
    .lang-toggle{display:inline-flex;background:var(--card);border:1px solid var(--ring);border-radius:999px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .lang-toggle button{min-width:60px;padding:8px 12px;font-weight:800;border:0;background:transparent;cursor:pointer;line-height:1;color:var(--text)}
    .lang-toggle button+button{border-left:1px solid var(--ring)}
    .lang-toggle button.is-active{background:var(--accent);color:#000}
    @media (max-width:600px){ .brand{font-size:20px} .right-actions{gap:6px} .action-pill span:last-child{display:none} }

    /* ===== Card ===== */
    .wrap{display:flex;justify-content:center;padding:16px}
    .card{width:min(980px,96vw);background:var(--card);border-radius:20px;box-shadow:var(--shadow);padding:22px 22px 26px}
    .title{font-size:28px;font-weight:900;margin:0 0 6px}
    .subtitle{color:var(--muted);margin:0 0 14px}
    hr.sep{border:none;border-top:1px solid var(--ring);margin:14px 0 18px}

    .section{margin-top:18px}
    .section h4{margin:0 0 10px;font-size:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:820px){ .grid{grid-template-columns:1fr} }

    .field{display:flex;flex-direction:column;gap:6px}
    .label-row{display:flex;align-items:center;gap:8px;font-weight:800}
    .label-icon{width:22px;height:22px;display:grid;place-items:center;border-radius:8px;background:#f3f4f6}
    .input,.donerd-input,.field input[type="text"], .field input[type="number"], .field input[type="time"], .field textarea{
      border:1px solid var(--ring);border-radius:12px;padding:12px 14px;font-size:14px;outline:0;background:#fff
    }
    .field textarea{min-height:84px;resize:vertical}
    .field input:focus, .field textarea:focus{box-shadow:0 0 0 3px rgba(249,115,22,.25)}

    .chip-row{display:flex;flex-wrap:wrap;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;background:var(--chip);color:var(--chipText);border:1px solid var(--ring);cursor:pointer;user-select:none;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .chip input{display:none}
    .chip.active{background:rgba(249,115,22,.16);border-color:rgba(249,115,22,.35)}

    .pill{display:inline-flex;align-items:center;gap:8px;background:#f8fafc;border:1px solid var(--ring);border-radius:999px;padding:8px 12px}
    .pill strong{font-size:12px}
    .coords{display:flex;gap:10px;flex-wrap:wrap}

    #map{height:320px;border-radius:14px;border:1px solid var(--ring);box-shadow:0 4px 12px rgba(0,0,0,.08)}

    .hours-grid{display:grid;grid-template-columns: 110px 1fr; gap:10px; align-items:center}
    .hours-row{display:flex; gap:8px; flex-wrap:wrap}
    .hours-row .slot{display:flex; align-items:center; gap:6px}
    .hours-row input[type="time"]{padding:8px 10px; border-radius:10px}

    .actions{display:flex;gap:12px;justify-content:center;margin-top:22px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;font-weight:900;border:none;cursor:pointer;transition:transform .05s ease, box-shadow .15s ease}
    .btn:active{transform:translateY(1px)}
    .btn-primary{
      width:100%;max-width:440px;border-radius:999px;padding:14px 18px;
      background:linear-gradient(180deg,#fdbb74 0%,#fb923c 50%,#f97316 100%);
      color:#000;box-shadow:0 10px 22px rgba(249,115,22,.35)
    }
    .btn-secondary{border-radius:999px;padding:12px 16px;background:#fff;border:1px solid var(--ring);color:#0f172a;box-shadow:0 6px 14px rgba(0,0,0,.08)}
    .i{width:18px;height:18px;display:grid;place-items:center;border-radius:999px;background:#fff1;border:1px solid #0001}

    /* ===== Dropzone ===== */
    .dropzone{
      border:2px dashed var(--ring);
      background:#fff;
      border-radius:14px;
      padding:16px;
      text-align:center;
      cursor:pointer;
      transition:background .15s ease, border-color .15s ease;
    }
    .dropzone:hover{ background:#f9fafb }
    .dropzone.dragover{ background:#fff7ed; border-color:#f97316 }
    .dropzone input{ display:none }
    .dz-preview{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px }
    .dz-thumb{
      width:96px; height:96px; border-radius:12px; overflow:hidden;
      border:2px solid transparent; box-shadow:0 2px 8px rgba(0,0,0,.06);
      background:#0001; position:relative; cursor:pointer;
    }
    .dz-thumb img{ width:100%; height:100%; object-fit:cover }
    .dz-thumb small{
      position:absolute; left:4px; bottom:4px; background:#000a; color:#fff;
      border-radius:8px; padding:2px 6px; font-weight:800; font-size:11px;
    }
    .dz-thumb.is-hero{ border-color:#fb923c }
  </style>
</head>
<body>
  <!-- ===== Topbar ===== -->
  <div id="navbar">
    <div class="nav-inner">
      <div class="brand" aria-label="D√∂nerd"><span class="dot"></span><span>D√∂nerd</span></div>

      <div class="right-actions">
        <button class="action-pill" onclick="location.href='index.html'"><span class="action-icon">üó∫Ô∏è</span><span>Karte</span></button>
        <button class="action-pill" onclick="location.href='feedback.html'"><span class="action-icon">üí¨</span><span>Feedback</span></button>
        <button class="action-pill" onclick="location.href='selection.html'"><span class="action-icon">üìã</span><span>Preisliste</span></button>
        <button class="action-pill is-active" onclick="location.href='add-shop.html'"><span class="action-icon">‚ûï</span><span>Shop hinzuf√ºgen</span></button>
        <button class="action-pill" onclick="location.href='about.html'"><span class="action-icon">üë§</span><span>√úber mich</span></button>

        <!-- Login/Profile -->
        <button class="action-pill" id="loginBtn" title="Login">
          <span class="action-icon">üîë</span><span id="loginText">Login</span>
        </button>

        <div class="lang-toggle" role="group" aria-label="Language">
          <button type="button" data-lang="de" aria-pressed="true" class="is-active">DE</button>
          <button type="button" data-lang="en" aria-pressed="false">EN</button>
        </div>
        <button id="mobileMenuBtn" class="action-pill" aria-haspopup="true" aria-expanded="false"
  onclick="(function(m){if(!m)return;const open=m.classList.contains('hidden');m.classList.toggle('hidden',!open);this.setAttribute('aria-expanded',open?'true':'false');})(document.getElementById('mobileMenu'))">‚ò∞</button>

      </div>
    </div>
  </div>

  <!-- ===== Content ===== -->
  <main class="wrap">
    <section class="card" aria-label="Shop hinzuf√ºgen">
      <h1 class="title">üßæ <span data-i18n="add.title">Shop hinzuf√ºgen</span></h1>
      <p class="subtitle" data-i18n="add.subtitle">Trage die Grunddaten ein und setze den Pin auf der Karte.</p>
      <hr class="sep" />

      <!-- Basics -->
      <div class="section">
        <h4 class="label-row"><span data-i18n="add.basics">Basis</span></h4>
        <div class="grid">
          <div class="field">
            <div class="label-row"><label for="name" data-i18n="add.name">Name</label></div>
            <input id="name" class="input" type="text" placeholder="Hasir, R√ºyam‚Ä¶" data-i18n-placeholder="add.namePh" />
          </div>
          <div class="field">
            <div class="label-row"><span class="label-icon">üìç</span><label for="address" data-i18n="add.addr">Adresse</label></div>
            <input id="address" class="input" type="text" placeholder="Stra√üe 1, Berlin‚Ä¶" data-i18n-placeholder="add.addrPh" />
          </div>
        </div>
      </div>

      <!-- Location -->
      <div class="section">
        <h4 class="label-row"><span data-i18n="add.location">Standort</span></h4>
        <div id="map"></div>
        <div class="coords" style="margin-top:10px;">
          <button id="geoBtn" class="btn btn-secondary" type="button">üìç <span data-i18n="add.locate">Meine Position</span></button>
          <div class="pill"><strong>Lat</strong><span id="latOut">‚Äì</span></div>
          <div class="pill"><strong>Lng</strong><span id="lngOut">‚Äì</span></div>
        </div>
      </div>

      <!-- Categories -->
      <div class="section">
        <h4 class="label-row"><span data-i18n="cat.title">Kategorie</span></h4>
        <div class="chip-row">
          <label class="chip"><input type="checkbox" id="vegOnly"><span>ü•¨</span><span data-i18n="cat.veg">Vegetarisch</span></label>
          <label class="chip"><input type="checkbox" id="meatOnly"><span>üçñ</span><span data-i18n="cat.meat">Fleisch</span></label>
          <label class="chip"><input type="checkbox" id="saucesOnly"><span>ü•´</span><span data-i18n="cat.sauces">Saucen</span></label>
          <label class="chip"><input type="checkbox" id="breadOnly"><span>ü•ñ</span><span data-i18n="cat.bread">Brot hausgemacht</span></label>
          <label class="chip"><input type="checkbox" id="cards"><span>üí≥</span><span>Kartenzahlung</span></label>
        </div>
      </div>

      <!-- Prices -->
      <div class="section">
        <h4 class="label-row"><span data-i18n="price.title">Preise</span></h4>
        <div class="grid">
          <div class="field">
            <div class="label-row"><span class="label-icon">ü•ô</span><label for="pK" data-i18n="price.kebap">Kebap ‚Ç¨</label></div>
            <input id="pK" type="number" step="0.1" min="0" placeholder="z.B. 5.5">
          </div>
          <div class="field">
            <div class="label-row"><span class="label-icon">üåØ</span><label for="pD" data-i18n="price.durum">D√ºr√ºm ‚Ç¨</label></div>
            <input id="pD" type="number" step="0.1" min="0" placeholder="z.B. 6.0">
          </div>
          <div class="field">
            <div class="label-row"><span class="label-icon">üì¶</span><label for="pB" data-i18n="price.box">Box ‚Ç¨</label></div>
            <input id="pB" type="number" step="0.1" min="0" placeholder="z.B. 7.0">
          </div>
        </div>
      </div>

      <!-- Opening hours -->
      <div class="section">
        <h4 class="label-row"><span class="label-icon">‚è∞</span><span>√ñffnungszeiten</span></h4>
        <div class="hours-grid" id="hoursGrid"></div>
      </div>

      <!-- Images (Drag & Drop / Upload) -->
      <div class="section">
        <h4 class="label-row"><span class="label-icon">üñºÔ∏è</span><span>Bilder</span></h4>
        <div class="grid">
          <div class="field">
            <label class="label-row">Uploads</label>
            <label id="dropzone" class="dropzone">
              <input id="fileInput" type="file" accept="image/*" multiple />
              <div>Ziehe Bilder hierher oder <u>klicke zum Ausw√§hlen</u>.</div>
              <small style="color:var(--muted)">Tipp: Tippe auf ein Vorschaubild, um es als <b>Hero</b> zu w√§hlen.</small>
            </label>
            <div id="dzPreview" class="dz-preview"></div>
          </div>
          <div class="field">
            <label class="label-row">Ausgew√§hltes Hero-Bild</label>
            <div id="heroHint" class="pill">Noch keines gew√§hlt ‚Äì wir nehmen das erste.</div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button id="saveBtn" class="btn btn-primary" type="button"><span class="i">‚úÖ</span><span data-i18n="add.create">Anlegen</span></button>
        <button class="btn btn-secondary" type="button" onclick="location.href='index.html'"><span class="i">‚Ü©Ô∏è</span><span data-i18n="add.cancel">Abbrechen</span></button>
      </div>
    </section>
  </main>

  <!-- Minimal auth modal -->
  <div id="authOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1300">
    <div id="authModal" role="dialog" aria-modal="true" aria-labelledby="authTitle"
        style="width:min(420px,92vw);background:var(--card);color:var(--text);border:1px solid var(--ring);
              border-radius:14px;box-shadow:0 12px 30px rgba(0,0,0,.35);padding:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px">
        <div id="authTitle" style="font-weight:900;font-size:18px">Anmelden</div>
        <button id="authClose" class="btn btn-secondary">‚úñ</button>
      </div>
      <div style="display:grid;gap:10px">
        <input id="authEmail" class="donerd-input" type="email" placeholder="E-Mail" autocomplete="email" />
        <input id="authPassword" class="donerd-input" type="password" placeholder="Passwort" />
        <div id="authError" style="min-height:18px;color:#ef4444;font-weight:700;font-size:12px"></div>
        <div style="display:flex;gap:8px">
          <button id="authSignIn" class="btn btn-primary" style="flex:1">Einloggen</button>
          <button id="authSignUp" class="btn btn-secondary" style="flex:1">Konto erstellen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- i18n (subset) -->
  <script>
    const DICTS={de:{
      add:{title:"Shop hinzuf√ºgen", subtitle:"Trage die Grunddaten ein und setze den Pin auf der Karte.", basics:"Basis",
           name:"Name", namePh:"Hasir, R√ºyam‚Ä¶", addr:"Adresse", addrPh:"Stra√üe 1, Berlin‚Ä¶",
           location:"Standort", locate:"üìç Meine Position", create:"Anlegen", cancel:"Abbrechen"},
      cat:{title:"Kategorie", veg:"Vegetarisch", meat:"Fleisch", sauces:"Saucen", bread:"Brot hausgemacht"},
      price:{title:"Preise", kebap:"Kebap ‚Ç¨", durum:"D√ºr√ºm ‚Ç¨", box:"Box ‚Ç¨"},
      msg:{needName:"Bitte einen Namen eingeben.", needPos:"Bitte einen Punkt auf der Karte setzen.",
           saved:"Shop gespeichert ‚úÖ", saving:"Speichere‚Ä¶", error:"Speichern fehlgeschlagen. Details in der Konsole."},
      days:{mon:"Montag",tue:"Dienstag",wed:"Mittwoch",thu:"Donnerstag",fri:"Freitag",sat:"Samstag",sun:"Sonntag"},
    }, en:{
      add:{title:"Add Shop", subtitle:"Fill the basics and drop the pin on the map.", basics:"Basics",
           name:"Name", namePh:"Hasir, R√ºyam‚Ä¶", addr:"Address", addrPh:"Street 1, Berlin‚Ä¶",
           location:"Location", locate:"üìç My location", create:"Create", cancel:"Cancel"},
      cat:{title:"Category", veg:"Vegetarian", meat:"Meat", sauces:"Sauces", bread:"Homemade bread"},
      price:{title:"Prices", kebap:"Kebap ‚Ç¨", durum:"Durum ‚Ç¨", box:"Box ‚Ç¨"},
      msg:{needName:"Please enter a name.", needPos:"Please set a point on the map.",
           saved:"Shop saved ‚úÖ", saving:"Saving‚Ä¶", error:"Save failed. See console."},
      days:{mon:"Monday",tue:"Tuesday",wed:"Wednesday",thu:"Thursday",fri:"Friday",sat:"Saturday",sun:"Sunday"},
    }};
    const I18N=(()=>{let lang='de',dict=DICTS.de;
      const get=(o,p)=>p.split('.').reduce((a,k)=>a&&a[k]!=null?a[k]:undefined,o);
      const t=(k,fb)=>get(dict,k)??fb??k;
      function apply(){
        document.querySelectorAll('[data-i18n]').forEach(el=>el.textContent=t(el.dataset.i18n,el.textContent.trim()));
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>el.placeholder=t(el.dataset.i18nPlaceholder,el.placeholder));
        document.documentElement.lang=lang;
        document.querySelectorAll('.lang-toggle [data-lang]').forEach(b=>{const on=b.dataset.lang===lang; b.classList.toggle('is-active',on); b.setAttribute('aria-pressed',on?'true':'false');});
      }
      function set(l){lang=l;dict=DICTS[l]||DICTS.de;localStorage.setItem('lang',l);apply();}
      function init(){set(localStorage.getItem('lang')||(['de','en'].includes((navigator.language||'').slice(0,2))?(navigator.language||'').slice(0,2):'de'));
        document.addEventListener('click',e=>{const b=e.target.closest('.lang-toggle [data-lang]'); if(b) set(b.dataset.lang);});}
      return {init,t};
    })();
    document.addEventListener('DOMContentLoaded', I18N.init);
  </script>

  <!-- Page logic -->
  <script>
    // ===== Supabase =====
    const SUPABASE_URL  = 'https://bcxeaxhhhvagpvomtsyi.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjeGVheGhoaHZhZ3B2b210c3lpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNTUxMzcsImV4cCI6MjA3MDgzMTEzN30.HCnWgapZrDY4RIgdXM5eh2UkslFpSSuJwEUszZHtp0w';
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    const storage = supa.storage.from('shop-images'); // make sure this bucket exists & is public

    // ===== Login/Profile button =====
    document.addEventListener('DOMContentLoaded', async () => {
      const loginBtn  = document.getElementById('loginBtn');
      const loginText = document.getElementById('loginText');
      const authOv    = document.getElementById('authOverlay');
      const authClose = document.getElementById('authClose');

      async function setUser(user){
        if (user) {
          loginBtn.title = 'Profil';
          const first = user.user_metadata?.first_name;
          loginText.textContent = first ? `Hi, ${first}` : 'Profil';
        } else {
          loginBtn.title = 'Login';
          loginText.textContent = 'Login';
        }
      }

      const { data: { session } } = await supa.auth.getSession();
      await setUser(session?.user ?? null);
      supa.auth.onAuthStateChange(async (_ev, s) => setUser(s?.user ?? null));

      loginBtn?.addEventListener('click', async () => {
        const { data } = await supa.auth.getUser();
        if (data?.user) { window.location.href = 'profile.html'; return; }
        authOv.style.display = 'flex';
      });
      authClose?.addEventListener('click', ()=> authOv.style.display='none');
      document.getElementById('authSignIn')?.addEventListener('click', async ()=>{
        const email = document.getElementById('authEmail').value.trim();
        const pass  = document.getElementById('authPassword').value;
        const err   = document.getElementById('authError');
        err.textContent='';
        const { error } = await supa.auth.signInWithPassword({ email, password:pass });
        if(error){ err.textContent = error.message; return; }
        authOv.style.display='none';
      });
      document.getElementById('authSignUp')?.addEventListener('click', async ()=>{
        const email = document.getElementById('authEmail').value.trim();
        const pass  = document.getElementById('authPassword').value;
        const err   = document.getElementById('authError');
        err.textContent='';
        const { error } = await supa.auth.signUp({ email, password:pass });
        if(error){ err.textContent = error.message; return; }
        err.style.color = '#16a34a'; err.textContent = 'Registriert. Bitte E-Mail best√§tigen.';
      });
    });

    // ===== Helpers =====
    const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
    function refreshChips(){ $$('.chip').forEach(lb=>{ const input=lb.querySelector('input'); if(!input) return; lb.classList.toggle('active', input.checked);}); }
    const toNum = (v)=>{ if(v===''||v==null) return null; const n=parseFloat(String(v).replace(',','.')); return Number.isFinite(n)?n:null; };
    function slugify(s){
      return String(s).toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')
        || 'shop';
    }
    function randomId(len=5){ const chars='abcdefghjkmnpqrstuvwxyz23456789'; let out=''; for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)]; return out; }

    // ===== Opening hours UI =====
    const DAY_KEYS=['mon','tue','wed','thu','fri','sat','sun'];
    const HOURS_DEFAULT={open:'11:00', close:'19:00'};
    function buildHoursUI(){
      const grid = document.getElementById('hoursGrid');
      grid.innerHTML = '';
      DAY_KEYS.forEach(key=>{
        const label = I18N.t('days.'+key, key);
        const row = document.createElement('div'); row.className='hours-row';
        row.innerHTML = `
          <div class="slot">
            <input type="checkbox" id="day-${key}" checked>
            <label for="day-${key}">offen</label>
          </div>
          <div class="slot">
            <input type="time" id="open-${key}" value="${HOURS_DEFAULT.open}">
            ‚Äì
            <input type="time" id="close-${key}" value="${HOURS_DEFAULT.close}">
          </div>`;
        const labelDiv = document.createElement('div'); labelDiv.textContent = label;
        grid.appendChild(labelDiv);
        grid.appendChild(row);
      });
    }
    function collectOpeningHours(){
      const obj={}; const daysOn=[];
      DAY_KEYS.forEach(k=>{
        const on = document.getElementById('day-'+k).checked;
        const open  = document.getElementById('open-'+k).value || HOURS_DEFAULT.open;
        const close = document.getElementById('close-'+k).value || HOURS_DEFAULT.close;
        if(on){ obj[k] = [{open, close}]; daysOn.push(k); }
      });
      return { opening_hours: obj, opening_days: daysOn.join(',') };
    }

    // ===== Map =====
    let map, marker=null;
    function setMarker(lat,lng){
      if(marker) map.removeLayer(marker);
      marker=L.marker([lat,lng]).addTo(map);
      $('#latOut').textContent=Number(lat).toFixed(6);
      $('#lngOut').textContent=Number(lng).toFixed(6);
    }

    // ===== Uploads (drag & drop + previews) =====
    const selectedFiles = []; // File[]
    let heroIndex = -1;

    function addFiles(list){
      for(const file of list){
        if(!file.type.startsWith('image/')) continue;
        selectedFiles.push(file);
      }
      renderPreviews();
    }

    function renderPreviews(){
      const box = document.getElementById('dzPreview');
      box.innerHTML = '';
      selectedFiles.forEach((file, idx)=>{
        const url = URL.createObjectURL(file);
        const div = document.createElement('div');
        div.className = 'dz-thumb' + (idx===heroIndex ? ' is-hero' : '');
        div.title = 'Als Hero w√§hlen';
        div.innerHTML = `<img src="${url}" alt=""><small>${idx+1}</small>`;
        div.addEventListener('click', ()=>{
          heroIndex = idx;
          document.getElementById('heroHint').textContent = 'Hero gew√§hlt: Bild #' + (idx+1);
          renderPreviews();
        });
        box.appendChild(div);
      });
      if(heroIndex<0 && selectedFiles.length>0){
        document.getElementById('heroHint').textContent = 'Kein Hero ausgew√§hlt ‚Äì wir nehmen Bild #1';
      }
    }

    async function uploadAllImages(folder){
      // returns {heroUrl, urls[]}
      const urls = [];
      let heroUrl = null;

      for(let i=0;i<selectedFiles.length;i++){
        const f = selectedFiles[i];
        const safeName = `${Date.now()}_${i}_${(f.name||'img').replace(/[^a-z0-9\.\-_]/gi,'_')}`;
        const path = `${folder}/${safeName}`;
        const { error } = await storage.upload(path, f, { cacheControl: '3600', upsert: true, contentType: f.type || 'image/jpeg' });
        if(error){ console.error('upload failed', error); throw error; }
        const { data } = storage.getPublicUrl(path);
        const url = data?.publicUrl || null;
        if(url){ urls.push(url); if(i===heroIndex || (heroIndex<0 && i===0)) heroUrl = url; }
      }
      return { heroUrl, urls };
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // Map init
      map = L.map('map').setView([52.502,13.402],13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      map.on('click', e=> setMarker(e.latlng.lat, e.latlng.lng));
      document.getElementById('geoBtn').addEventListener('click', ()=> map.locate({setView:true, maxZoom:16}));
      map.on('locationfound', e=> setMarker(e.latlng.lat, e.latlng.lng));

      // Chips
      document.addEventListener('change', e=>{ if(e.target.matches('.chip input')) refreshChips(); });
      refreshChips();

      // Hours UI
      buildHoursUI();

      // Dropzone
      const dz = document.getElementById('dropzone');
      const fi = document.getElementById('fileInput');
      dz.addEventListener('click', ()=> fi.click());
      fi.addEventListener('change', e=> addFiles(e.target.files||[]));
      dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.classList.add('dragover'); });
      dz.addEventListener('dragleave', ()=> dz.classList.remove('dragover'));
      dz.addEventListener('drop', e=>{
        e.preventDefault(); dz.classList.remove('dragover');
        addFiles(e.dataTransfer.files||[]);
      });

      // Save
      document.getElementById('saveBtn').addEventListener('click', saveShop);
    });

    async function saveShop(){
      const name=$('#name').value.trim();
      if(!name){ alert(I18N.t('msg.needName')); return; }

      const lat=parseFloat($('#latOut').textContent.replace(',','.'));
      const lng=parseFloat($('#lngOut').textContent.replace(',','.'));
      if(!Number.isFinite(lat)||!Number.isFinite(lng)){ alert(I18N.t('msg.needPos')); return; }

      const { opening_hours, opening_days } = collectOpeningHours();

      // Prepare ID & folder for uploads
      const id = `${slugify(name)}-${randomId()}`;
      let heroUrl=null, imageUrls=[];

      // Upload to Storage if files selected
      if(selectedFiles.length){
        try{
          const r = await uploadAllImages(id); // folder per shop id
          heroUrl = r.heroUrl;
          imageUrls = r.urls;
        }catch(e){
          console.error('Upload error:', e);
          alert('Bild-Upload fehlgeschlagen.');
          return;
        }
      }

      const row = {
        id,
        name,
        address: ($('#address').value||'').trim(),
        lat, lng,
        vegetarian: $('#vegOnly').checked,
        meat: $('#meatOnly').checked,
        sauces: $('#saucesOnly').checked,
        homemade_bread: $('#breadOnly').checked,
        payment_cards: $('#cards').checked,          // card payments
        price_kebap: toNum($('#pK').value),
        price_durum: toNum($('#pD').value),
        price_box:   toNum($('#pB').value),
        opening_days,                                 // comma list for other page
        opening_hours,                                // jsonb
        hero_image_url: heroUrl,
        image_urls: imageUrls.length ? imageUrls : null,
        rating_admin: null
      };

      try{
        const btn = document.getElementById('saveBtn');
        const old = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = '‚è≥ ' + I18N.t('msg.saving');

        const { data, error } = await supa.from('shops').insert([row]).select('*').single();

        btn.disabled = false; btn.innerHTML = old;

        if(error){
          console.error('[Supabase] insert error:', error);
          alert(I18N.t('msg.error'));
          return;
        }
        console.log('[Supabase] inserted:', data);
        alert(I18N.t('msg.saved'));
        location.href='index.html';
      }catch(err){
        console.error(err);
        alert(I18N.t('msg.error'));
      }
    }
  </script>
  <!-- Mobile dropdown (fixed, above the content) -->
<div id="mobileMenu" class="hidden">
  <button class="item" onclick="location.href='index.html'">üó∫Ô∏è Karte</button>
  <button class="item" onclick="location.href='feedback.html'">üí¨ Feedback</button>
  <button class="item" onclick="location.href='selection.html'">üìã Preisliste</button>
  <button class="item" onclick="location.href='add-shop.html'">‚ûï Shop hinzuf√ºgen</button>
  <button class="item" onclick="location.href='about.html'">üë§ √úber mich</button>
  <button class="item" id="mobileProfile">üîë Login/Profil</button>
</div>

<script>
/* Optional nicety: close menu after a click; route Login/Profile smartly */
(function(){
  const menu = document.getElementById('mobileMenu');
  const btn  = document.getElementById('mobileMenuBtn');
  if(!menu || !btn) return;

  // Close after choosing an item
  menu.querySelectorAll('.item').forEach(el=>{
    el.addEventListener('click', ()=> {
      menu.classList.add('hidden');
      btn.setAttribute('aria-expanded','false');
    });
  });

  // Login/Profile behavior reuses existing loginBtn logic if present
  const prof = document.getElementById('mobileProfile');
  const loginBtn = document.getElementById('loginBtn');
  if (prof && loginBtn) {
    prof.addEventListener('click', ()=> {
      loginBtn.click();
    });
  }

  // Close on outside tap / ESC (defensive)
  document.addEventListener('click', (e)=>{
    if (menu.classList.contains('hidden')) return;
    const inMenu = menu.contains(e.target) || e.target === btn;
    if (!inMenu) { menu.classList.add('hidden'); btn.setAttribute('aria-expanded','false'); }
  });
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') { menu.classList.add('hidden'); btn.setAttribute('aria-expanded','false'); }
  });
})();
</script>

</body>
</html>
